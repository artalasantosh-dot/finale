<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Environment Monitoring Dashboard</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --good:#10b981; --warn:#f59e0b; --bad:#ef4444; --glass: rgba(255,255,255,0.04);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071028 0%, #081226 100%);color:#e6eef6}
    .app{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    header h1{font-size:20px;margin:0}
    .controls{display:flex;gap:10px;align-items:center}
    .controls > *{background:var(--card);border-radius:8px;padding:8px 10px;border:1px solid rgba(255,255,255,0.03)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .metric{display:flex;align-items:center;justify-content:space-between}
    .metric .left{display:flex;flex-direction:column}
    .metric h2{margin:0;font-size:18px}
    .value{font-size:26px;font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    .chart-wrap{grid-column:1/4}
    #historyChart{height:280px}
    .alerts{max-height:180px;overflow:auto}
    .alert{padding:10px;border-radius:8px;margin-bottom:8px;font-size:13px}
    .alert.good{background:rgba(16,185,129,0.08);border-left:4px solid var(--good);color:var(--good)}
    .alert.warn{background:rgba(245,158,11,0.06);border-left:4px solid var(--warn);color:var(--warn)}
    .alert.bad{background:rgba(239,68,68,0.06);border-left:4px solid var(--bad);color:var(--bad)}
    footer{display:flex;justify-content:space-between;margin-top:14px;gap:10px}
    .btn{background:var(--accent);color:#042023;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(6,182,212,0.12)}
    .settings{display:flex;gap:10px;align-items:center}
    input[type=range]{width:140px}
    @media (max-width:920px){.grid{grid-template-columns:repeat(2,1fr)} .chart-wrap{grid-column:1/3}}
    @media (max-width:640px){.grid{grid-template-columns:1fr} .chart-wrap{grid-column:1/2}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Environment Monitoring Dashboard</h1>
      <div class="controls">
        <div class="settings card">
          <label class="small">Auto-update: <input id="autoToggle" type="checkbox" checked></label>
          <label class="small">Interval (s): <input id="interval" type="number" min="1" max="60" value="5" style="width:60px;margin-left:6px"></label>
        </div>
        <button id="refresh" class="btn">Refresh</button>
        <button id="export" class="btn ghost">Export CSV</button>
      </div>
    </header>

    <section class="grid">
      <div class="card">
        <div class="metric">
          <div class="left"><h2>Temperature</h2><div class="small">°C</div></div>
          <div class="value" id="tempVal">--</div>
        </div>
        <div class="small">Sensor: Indoor • Range: -20 — 60</div>
      </div>

      <div class="card">
        <div class="metric">
          <div class="left"><h2>Humidity</h2><div class="small">% RH</div></div>
          <div class="value" id="humVal">--</div>
        </div>
        <div class="small">Sensor: Indoor • Range: 0 — 100</div>
      </div>

      <div class="card">
        <div class="metric">
          <div class="left"><h2>AQI</h2><div class="small">US EPA</div></div>
          <div class="value" id="aqiVal">--</div>
        </div>
        <div class="small">Lower is better</div>
      </div>

      <div class="card">
        <div class="metric">
          <div class="left"><h2>CO₂</h2><div class="small">ppm</div></div>
          <div class="value" id="co2Val">--</div>
        </div>
        <div class="small">Indoor air quality indicator</div>
      </div>

      <div class="card">
        <div class="metric">
          <div class="left"><h2>Sound</h2><div class="small">dB</div></div>
          <div class="value" id="noiseVal">--</div>
        </div>
        <div class="small">Ambient noise level</div>
      </div>

      <div class="card">
        <h2>Alerts</h2>
        <div class="alerts" id="alerts"></div>
      </div>

      <div class="card chart-wrap">
        <h2 style="margin-top:0">History (last 60 points)</h2>
        <canvas id="historyChart"></canvas>
      </div>
    </section>

    <footer>
      <div class="card small">Status: <span id="status">Initializing...</span></div>
      <div class="card small">Last update: <span id="lastUpdate">--</span></div>
    </footer>
  </div>

  <script>
    // Simple single-file monitoring dashboard
    const state = {
      points: [], // {t, temp, hum, aqi, co2, noise}
      maxPoints: 60,
      auto: true,
      intervalSec: 5
    };

    // Grab elements
    const tempVal = document.getElementById('tempVal');
    const humVal = document.getElementById('humVal');
    const aqiVal = document.getElementById('aqiVal');
    const co2Val = document.getElementById('co2Val');
    const noiseVal = document.getElementById('noiseVal');
    const alertsEl = document.getElementById('alerts');
    const statusEl = document.getElementById('status');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const autoToggle = document.getElementById('autoToggle');
    const intervalInput = document.getElementById('interval');
    const refreshBtn = document.getElementById('refresh');
    const exportBtn = document.getElementById('export');

    // Chart setup
    const ctx = document.getElementById('historyChart');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {label:'Temperature (°C)', data:[], tension:0.25, borderWidth:2, yAxisID:'y'},
          {label:'Humidity (%)', data:[], tension:0.25, borderWidth:2, yAxisID:'y1'},
          {label:'AQI', data:[], tension:0.25, borderWidth:2, yAxisID:'y2'}
        ]
      },
      options: {
        interaction:{mode:'index',intersect:false},
        scales:{
          x:{display:true},
          y:{type:'linear',position:'left',display:true},
          y1:{type:'linear',position:'right',display:false},
          y2:{type:'linear',position:'right',display:false}
        },
        plugins:{legend:{position:'top'}}
      }
    });

    // Utilities: simulated sensor data generator
    function simulateReading(prev){
      // Create somewhat-smooth values by nudging previous
      const prevTemp = prev?.temp ?? 22 + Math.random()*2;
      const prevHum = prev?.hum ?? 45 + Math.random()*4;
      const prevAqi = prev?.aqi ?? 40 + Math.random()*8;
      const prevCo2 = prev?.co2 ?? 420 + Math.random()*30;
      const prevNoise = prev?.noise ?? 35 + Math.random()*6;

      const n = v => Math.round((v + (Math.random()-0.5)*2.5)*10)/10;

      return {
        t: new Date(),
        temp: n(prevTemp + (Math.random()-0.48)*0.8),
        hum: Math.max(0, Math.min(100, n(prevHum + (Math.random()-0.5)*1.6))),
        aqi: Math.max(0, Math.round(prevAqi + (Math.random()-0.5)*6)),
        co2: Math.max(300, Math.round(prevCo2 + (Math.random()-0.5)*20)),
        noise: Math.max(20, Math.round(prevNoise + (Math.random()-0.5)*4))
      };
    }

    function pushPoint(pt){
      state.points.push(pt);
      if(state.points.length>state.maxPoints) state.points.shift();
      updateUI(pt);
      updateChart();
      checkAlerts(pt);
    }

    function updateUI(pt){
      tempVal.textContent = pt.temp.toFixed(1);
      humVal.textContent = pt.hum.toFixed(0);
      aqiVal.textContent = pt.aqi;
      co2Val.textContent = pt.co2;
      noiseVal.textContent = pt.noise;
      lastUpdateEl.textContent = pt.t.toLocaleTimeString();
      statusEl.textContent = 'OK';
    }

    function updateChart(){
      const labels = state.points.map(p=>p.t.toLocaleTimeString());
      chart.data.labels = labels;
      chart.data.datasets[0].data = state.points.map(p=>p.temp);
      chart.data.datasets[1].data = state.points.map(p=>p.hum);
      chart.data.datasets[2].data = state.points.map(p=>p.aqi);
      chart.update();
    }

    function checkAlerts(pt){
      // simple thresholds
      const items = [];
      if(pt.aqi>150) items.push({level:'bad',text:AQI ${pt.aqi} — Unhealthy});
      else if(pt.aqi>100) items.push({level:'warn',text:AQI ${pt.aqi} — Unhealthy for some});
      if(pt.co2>1200) items.push({level:'bad',text:CO₂ ${pt.co2} ppm — Poor ventilation});
      else if(pt.co2>800) items.push({level:'warn',text:CO₂ ${pt.co2} ppm — Consider ventilation});
      if(pt.temp>35) items.push({level:'bad',text:Temperature ${pt.temp.toFixed(1)}°C — High});
      if(pt.noise>75) items.push({level:'warn',text:Noise ${pt.noise} dB — Loud environment});

      // render alerts area (keep last 30 alerts)
      items.forEach(it=>{
        const div = document.createElement('div');
        div.className = alert ${it.level};
        div.textContent = ${new Date().toLocaleTimeString()} — ${it.text};
        alertsEl.prepend(div);
      });
      // trim
      while(alertsEl.children.length>30) alertsEl.removeChild(alertsEl.lastChild);
    }

    // Auto-update loop
    let timer = null;
    function startTimer(){
      if(timer) clearInterval(timer);
      timer = setInterval(()=>{
        if(!state.auto) return;
        step();
      }, state.intervalSec*1000);
    }

    function step(){
      const prev = state.points[state.points.length-1];
      const next = simulateReading(prev);
      pushPoint(next);
    }

    // Controls
    autoToggle.addEventListener('change', e=>{
      state.auto = e.target.checked; saveSettings();
    });
    intervalInput.addEventListener('change', e=>{
      let v = parseInt(e.target.value)||5; if(v<1) v=1; if(v>60) v=60; state.intervalSec=v; saveSettings(); startTimer();
    });
    refreshBtn.addEventListener('click', ()=>{ step(); });
    exportBtn.addEventListener('click', ()=>{ exportCSV(); });

    function exportCSV(){
      if(state.points.length===0) return alert('No data to export');
      const header = ['timestamp','temperature_C','humidity_pct','aqi','co2_ppm','noise_db'];
      const rows = state.points.map(p=>[p.t.toISOString(),p.temp,p.hum,p.aqi,p.co2,p.noise].join(','));
      const csv = header.join(',') + '\n' + rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = env-data-${new Date().toISOString().slice(0,19)}.csv;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Persist simple settings
    function saveSettings(){
      localStorage.setItem('envdash_settings', JSON.stringify({auto:state.auto,interval:state.intervalSec}));
    }
    function loadSettings(){
      const s = JSON.parse(localStorage.getItem('envdash_settings')||'null');
      if(s){ state.auto = !!s.auto; state.intervalSec = s.interval; autoToggle.checked = state.auto; intervalInput.value = state.intervalSec; }
    }

    // Init with a handful of historical points
    function seed(){
      let p = null;
      for(let i=0;i<12;i++){ p = simulateReading(p); p.t = new Date(Date.now() - (11-i)*state.intervalSec*1000); state.points.push(p); }
      updateChart(); updateUI(state.points[state.points.length-1]);
    }

    // start
    loadSettings(); seed(); startTimer();

    // ensure timer follows the setting
    setInterval(()=>{ if(state.auto===false) statusEl.textContent='Paused'; },1000);

    // start/stop when tab hidden to save CPU
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden){ statusEl.textContent='Inactive (tab hidden)'; }
      else statusEl.textContent='Active';
    });

    // expose quick debug functions on window
    window.env = {state, step, exportCSV};
  </script>
</body>
</html>
